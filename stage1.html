<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: JS Interpreter</title>
  <script src="acorn_interpreter.js"></script>
  <script src="google-blockly/blockly_compressed.js"></script>
  <script src="google-blockly/blocks_compressed.js"></script>
  <script src="google-blockly/javascript_compressed.js"></script>
  <script src="msg-C.js"></script>
  <script src="blocks-C.js"></script>
  <script src="blocks-altered.js"></script>
  <style>
    * {
      margin: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
        overflow: hidden;
    }
    #main > * {
      display: inline-block;
    }
    #menu > ul > li {
      margin-left: 2em;
      display: inline-block;
    }
    #menu > ul > li::before {
      content: '> ';
    }
  </style>
</head>
<body>
  <div id="menu" style="width:100%; height: 20px">
    <ul>
      <li><a href="?a1">a1</a></li>
      <li><a href="?a2a">a2a</a> <a href="?a2b">a2b</a> <a href="?a2c">a2c</a> <a href="?a2d">a2d</a></li>
      <li><a href="?a3">a3</a></li>
    </ul>
  </div>
  <div id="main" style="width:100%; height:auto; position:absolute; top:20px; bottom:0">
    <div id="blocklyDiv" style="height:100%; width: 45%;"></div>
    <textarea id="msg" style="height:100%; width: 45%;"></textarea>
  </div>

<xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
  <category name="主程式">
    <block type="main">
      <statement name="NAME">
        <shadow type="cout">
          <value name="NAME">
            <shadow type="outstream_text">
              <field name="NAME">Hello, world!</field>
            </shadow>
          </value>
        </shadow>
      </statement>
    </block>
  </category>
  <category name="輸入輸出">
    <block type="cout"></block>
    <block type="outstream_text">
      <field name="NAME">文字</field>
    </block>
    <block type="outstream_var">
      <field name="NAME">a</field>
    </block>
    <block type="outstream_endl"></block>
    <block type="cin"></block>
    <block type="instream_var">
      <field name="NAME">a</field>
    </block>
  </category>
  <category name="變數" colour="#A65C81" custom="VARIABLE"></category>
  <category name="算數">
    <block type="math_number">
      <field name="NUM">0</field>
    </block>
    <block type="math_arithmetic">
      <field name="OP">ADD</field>
    </block>
  </category>
</xml>

  <xml id="startBlocks" style="display: none">
  </xml>
  
  <script src="answers.js"></script>
  <script>
    var param = window.location.toString().split('?');
    if (param.length>1) param = param[1];
    else                param = null;

    var workspace = Blockly.inject('blocklyDiv',
        {media: 'google-blockly/media/',
         toolbox: document.getElementById('toolbox')});
    if (param!=null && typeof ansXml[param]!=='undefined') {
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(ansXml[param]), workspace);
    }
    else {
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
    }
  </script>
  <script>
    workspace.addChangeListener(function(event){
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      document.getElementById("msg").value = xml_text;
    });
  </script>
  <script>
    /*
    var myInterpreter = null;

    function initApi(interpreter, scope) {
      // Add an API function for the alert() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(scope, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));
    }

    var highlightPause = false;

    function highlightBlock(id) {
      workspace.highlightBlock(id);
      highlightPause = true;
    }

    function parseCode() {
      // Generate JavaScript code and parse it.
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      myInterpreter = new Interpreter(code, initApi);

      alert('Ready to execute this code:\n\n' + code);
      document.getElementById('stepButton').disabled = '';
      highlightPause = false;
      workspace.highlightBlock(null);
    }

    function stepCode() {
      try {
        var ok = myInterpreter.step();
      } finally {
        if (!ok) {
          // Program complete, no more code to execute.
          document.getElementById('stepButton').disabled = 'disabled';
          workspace.highlightBlock(null);
          return;
        }
      }
      if (highlightPause) {
        // A block has been highlighted.  Pause execution here.
        highlightPause = false;
      } else {
        // Keep executing until a highlight statement is reached.
        stepCode();
      }
    }
    */
  </script>

</body>
</html>
