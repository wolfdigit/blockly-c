<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Blockly Demo: JS Interpreter</title>
  <!--<script src="acorn_interpreter.js"></script>-->
  <script src="google-blockly/blockly_compressed.js"></script>
  <script src="google-blockly/blocks_compressed.js"></script>
  <!--<script src="google-blockly/javascript_compressed.js"></script>-->
  <script src="google-blockly/demos/prettify.js"></script>
  <link rel="stylesheet" type="text/css" href="google-blockly/demos/prettify.css">
  <script src="msg-C.js"></script>
  <script src="blocks-C.js"></script>
  <script src="blocks-altered.js"></script>
  <style>
    * {
      margin: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
        overflow: hidden;
    }
    #main > * {
      display: inline-block;
    }
    #menu > ul > li {
      margin-left: 2em;
      display: inline-block;
    }
    #menu > ul > li::before {
      content: '> ';
    }
  </style>
</head>
<body>
  <div id="menu" style="width:100%; height: 20px">
      <span>第一級 - 變數與運算</span> <!--<pre id="vars" style="display:inline-block; font-weight:bold">workspace.blockDB_['AoWF/PsGb_Haf0_Ggvn1'].inputList[3].fieldRow[0].textElement_.innerHTML</pre>-->
      <!--
    <ul>
      <li><a href="?a1">a1</a></li>
      <li><a href="?a2a">a2a</a> <a href="?a2b">a2b</a> <a href="?a2c">a2c</a> <a href="?a2d">a2d</a></li>
      <li><a href="?a3">a3</a></li>
    </ul>
-->
  </div>
  <div id="main" style="width:100%; height:auto; position:absolute; top:20px; bottom:0">
    <div id="blocklyDiv" style="height:100%; width: 45%;"></div>
    <div style="height:100%; width:3em">
        <button id="import" style="position:absolute; margin:auto; top:0; bottom:0; height:3em; width:3em" onclick="javascript:Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(document.getElementById('msg').value), workspace);">&lt;</button>
    </div>
    <textarea id="c_code" style="height:65%; width: 45%; position:absolute; top:0"></textarea>
    <textarea id="msg" style="height:30%; width: 45%; position:absolute; bottom:0"></textarea>
  </div>

<xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
  <category name="主程式" colour="#5ba55b">
    <block type="main">
      <statement name="NAME">
        <shadow type="cout">
          <value name="NAME">
            <shadow type="outstream_text">
              <field name="NAME">Hello, world!</field>
            </shadow>
          </value>
        </shadow>
      </statement>
    </block>
  </category>
  <category name="輸入輸出" colour="#5ba55b">
    <block type="cout"></block>
    <block type="outstream_text">
      <field name="NAME">文字</field>
    </block>
    <block type="outstream_var">
      <field name="NAME">a</field>
    </block>
    <block type="outstream_endl"></block>
    <block type="cin"></block>
    <block type="instream_var">
      <field name="NAME">a</field>
    </block>
  </category>
  <category name="變數" colour="#5ba55b" custom="VARIABLE"></category>
  <category name="算數" colour="#5ba55b">
    <block type="math_number">
      <field name="NUM">0</field>
    </block>
    <block type="math_arithmetic">
      <field name="OP">ADD</field>
    </block>
  </category>
  <category name="判斷式" colour="#a5935b">
    <block type="controls_if"></block>
    <block type="logic_compare">
      <field name="OP">EQ</field>
    </block>
    <block type="logic_operation">
      <field name="OP">AND</field>
    </block>
    <block type="logic_negate"></block>
    <block type="logic_boolean">
      <field name="BOOL">TRUE</field>
    </block>
  </category>
  <category name="迴圈" colour="#a55b5b">
    <block type="loop_for"></block>
  </category>
</xml>

  <xml id="startBlocks" style="display: none">
  </xml>
  
  <script src="answers.js"></script>
  <script>
    var param = window.location.toString().split('?');
    if (param.length>1) param = param[1];
    else                param = null;

    var workspace = Blockly.inject('blocklyDiv',
        {media: 'google-blockly/media/',
         toolbox: document.getElementById('toolbox')});
    if (param!=null && typeof ansXml[param]!=='undefined') {
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(ansXml[param]), workspace);
    }
    else {
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
    }
  </script>
  <script>
    function gen_c(block) {
      //console.log(block.id);
      var retv;
      retv = [];
      //retv = "[" + block.id + " ";
      for (var i in block.inputList) {
          var input = block.inputList[i];
          //console.log(input);
          var inputLine = "";
          for (var j in input.fieldRow) {
              inputLine += input.fieldRow[j].text_;
          }
          //inputLine += '\n';
          if (input.type==5) {          // dummy input
              //console.log(inputLine);
              //retv += "T5";
          }
          else if (input.type==3) {     // statement input
              //console.log(input);
              //console.log(Object.keys(input.connection.dbOpposite_));
              var childLines = [];
              //for (var j=777; j<input.connection.dbOpposite_.length; j++) {
              if (input.connection.targetConnection!=null) {
                  //console.log(input.connection.dbOpposite_[j]);
                  childLine = gen_c(input.connection.targetConnection.sourceBlock_);
                  var indent = '    ';
                  childLine = indent + childLine.split('\n').join('\n'+indent);
                  //inputLine = inputLine + childLine;
                  childLines.push(childLine);
              }
              inputLine = inputLine + '\n' + childLines.join('\n');
              //console.log(input.connection.dbOpposite_);
          }
          else if (input.type==1) {     // value input
              //console.log(input);
              var childLines = [];
              //for (var j=777; j<input.connection.dbOpposite_.length; j++) {
              if (input.connection.targetConnection!=null) {
                //childLine = gen_c(input.connection.dbOpposite_[j].sourceBlock_);
                childLine = gen_c(input.connection.targetConnection.sourceBlock_);
                //alert("["+childLine+"]");
                  
                childLines.push(childLine);
              }
              inputLine = inputLine + childLines.join('\n');
          }
          else {
              inputLine += "T"+input.type;
              console.log(input);
              //retv += "T"+input.type;
          }
          //if (!block.inputsIninputLine) inputLine += '\n';
          //retv += inputLine;
          retv.push(inputLine);
      }
      //retv += "]";
      if (block.inputsInline!==false) {
        retv = retv.join('');
      }
      else {
        retv = retv.join('\n');
      }


      if (block.nextConnection!=null && block.nextConnection.targetConnection!=null) {
        if (block.nextConnection.targetConnection.sourceBlock_.id != block.id) {
          retv += '\n' + gen_c(block.nextConnection.targetConnection.sourceBlock_);
        }
      }

      return retv;
    }
      
      
    workspace.addChangeListener(function(event){
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      document.getElementById("msg").value = xml_text;
        
        
        
      // var declare line
      var varLine;
      if (Blockly.Variables.allUsedVariables(workspace).length>0) {
          varLine = "int " + Blockly.Variables.allUsedVariables(workspace).join(', ') + ";";
      }
      else {
          varLine = "";
      }
      //document.getElementById("vars").innerHTML = varLine;
        
      var blockIds = Object.keys(workspace.blockDB_);
      //console.log(blockIds);
      for (var k in workspace.blockDB_) {
          //console.log(k);
          var block = workspace.blockDB_[k];
          //console.log(block);
          if (block.type=='main') {
              //block.inputList[3].fieldRow[0].textElement_.innerHTML = varLine;
              //block.inputList[3].fieldRow[0].text_ = varLine;
              block.inputList[3].fieldRow[0].setValue(varLine);
              
              c_code = gen_c(block);
              //console.log(c_code);
              document.getElementById('c_code').value = c_code;
          }
      }
        
    });
  </script>
  <script>
    /*
    var myInterpreter = null;

    function initApi(interpreter, scope) {
      // Add an API function for the alert() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(alert(text));
      };
      interpreter.setProperty(scope, 'alert',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for the prompt() block.
      var wrapper = function(text) {
        text = text ? text.toString() : '';
        return interpreter.createPrimitive(prompt(text));
      };
      interpreter.setProperty(scope, 'prompt',
          interpreter.createNativeFunction(wrapper));

      // Add an API function for highlighting blocks.
      var wrapper = function(id) {
        id = id ? id.toString() : '';
        return interpreter.createPrimitive(highlightBlock(id));
      };
      interpreter.setProperty(scope, 'highlightBlock',
          interpreter.createNativeFunction(wrapper));
    }

    var highlightPause = false;

    function highlightBlock(id) {
      workspace.highlightBlock(id);
      highlightPause = true;
    }

    function parseCode() {
      // Generate JavaScript code and parse it.
      Blockly.JavaScript.STATEMENT_PREFIX = 'highlightBlock(%1);\n';
      Blockly.JavaScript.addReservedWords('highlightBlock');
      var code = Blockly.JavaScript.workspaceToCode(workspace);
      myInterpreter = new Interpreter(code, initApi);

      alert('Ready to execute this code:\n\n' + code);
      document.getElementById('stepButton').disabled = '';
      highlightPause = false;
      workspace.highlightBlock(null);
    }

    function stepCode() {
      try {
        var ok = myInterpreter.step();
      } finally {
        if (!ok) {
          // Program complete, no more code to execute.
          document.getElementById('stepButton').disabled = 'disabled';
          workspace.highlightBlock(null);
          return;
        }
      }
      if (highlightPause) {
        // A block has been highlighted.  Pause execution here.
        highlightPause = false;
      } else {
        // Keep executing until a highlight statement is reached.
        stepCode();
      }
    }
    */
  </script>

</body>
</html>
