<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>C++入門工具</title>
  <script src="google-blockly/blockly_compressed.js"></script>
  <script src="google-blockly/blocks_compressed.js"></script>
  <script src="msg-C.js"></script>
  <script src="blocks-C.js"></script>
  <script src="blocks-altered.js"></script>
  <style>
    * {
      margin: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
        overflow: hidden;
    }
    #main > * {
      display: inline-block;
    }
    #menu > ul > li {
      margin-left: 2em;
      display: inline-block;
    }
    #menu > ul > li::before {
      content: '> ';
    }
  </style>
</head>
<body>
  <div id="menu" style="width:100%; height: 20px">
      <span>第一級 - 變數與運算</span>
      <!--
    <ul>
      <li><a href="?a1">a1</a></li>
      <li><a href="?a2a">a2a</a> <a href="?a2b">a2b</a> <a href="?a2c">a2c</a> <a href="?a2d">a2d</a></li>
      <li><a href="?a3">a3</a></li>
    </ul>
-->
  </div>
    <script>
        function dontcopy() {
            alert("不給複製唷~ >_^");
            return false;
        }
    </script>
  <div id="main" style="width:100%; height:auto; position:absolute; top:20px; bottom:0">
    <div id="blocklyDiv" style="height:100%; width: 45%;"></div>
    <div style="height:100%; width:3em">
        <script>
            function exportToFile(target) {
                var msgBox = document.getElementById('msg');
                var textFile = null;
                var makeTextFile = function (text) {
                    var data = new Blob([text], {type: 'text/plain'});
                    
                    // If we are replacing a previously generated file we need to
                    // manually revoke the object URL to avoid memory leaks.
                    if (textFile !== null) {
                        window.URL.revokeObjectURL(textFile);
                    }

                    textFile = window.URL.createObjectURL(data);

                    return textFile;
                };
                //var newWin = window.open(makeTextFile(msgBox.value));
                target.href = makeTextFile(msgBox.value);
            }
            function importFile() {
                console.log(document.getElementById('upFile'));
            }
        </script>
        <div id="buttWrapper" style="position:absolute; margin:auto; top:0; bottom:0; height:6em; width:3em; display:none">
            <p>
            <a href="" id="exportButt" onclick="return exportToFile(this)" download="workspace.xml" style="display: none">下載</a></p>
            <p>
                上傳<br/>
            <input type="file" id="upFile">
            <button id="upload" onclick="javascript:Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(document.getElementById('msg').value), workspace);">&lt;</button>
            </p>
        </div>
        <button id="import" style="position:absolute; margin:auto; bottom:0; height:3em; width:3em" onclick="javascript:Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(document.getElementById('msg').value), workspace);">&lt;</button>
    </div>
    <textarea id="c_code" style="height:90%; width: 45%; position:absolute; top:0" oncopy="return dontcopy()" oncut="return dontcopy()" onpaste="return dontcopy()"></textarea>
    <textarea id="msg" style="height:5%; width: 45%; position:absolute; bottom:0"></textarea>
  </div>

<xml xmlns="http://www.w3.org/1999/xhtml" id="toolbox" style="display: none;">
  <category name="主程式" colour="#5ba55b">
    <block type="main">
      <statement name="NAME">
        <!--<shadow type="cout">
          <value name="NAME">
            <shadow type="outstream_text">
              <field name="NAME">Hello, world!</field>
            </shadow>
          </value>
        </shadow>-->
      </statement>
    </block>
    <block type="comment"></block>
    <block type="commentBlk"></block>
    <block type="blankLine"></block>
  </category>
  <category name="輸入輸出" colour="#5ba55b">
    <block type="cout"></block>
    <block type="outstream_text">
      <field name="NAME">文字</field>
    </block>
    <block type="outstream_var">
      <field name="NAME">a</field>
    </block>
    <block type="outstream_endl"></block>
    <block type="cin"></block>
    <block type="instream_var">
      <field name="NAME">a</field>
    </block>
  </category>
  <category name="變數" colour="#5ba55b" custom="VARIABLE"></category>
  <category name="算數" colour="#5ba55b">
    <block type="math_number">
      <field name="NUM">0</field>
    </block>
    <block type="math_arithmetic">
      <field name="OP1">ADD</field>
    </block>
  </category>
</xml>

  <xml id="startBlocks" style="display: none">
    <!--<block type="main"></block>-->
  </xml>
  
  <script src="answers.js"></script>
  <script>
    var param = window.location.toString().split('?');
    if (param.length>1) param = param[1];
    else                param = null;

    var workspace = Blockly.inject('blocklyDiv',
        {media: 'google-blockly/media/',
         toolbox: document.getElementById('toolbox'),
         zoom: {
           controls: true,
           wheel: true
         }
        });
    if (param!=null && typeof ansXml[param]!=='undefined') {
        Blockly.Xml.domToWorkspace(Blockly.Xml.textToDom(ansXml[param]), workspace);
    }
    else {
        Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'), workspace);
    }
  </script>
  <script src="gen-C.js"></script>
  <script>
    workspace.addChangeListener(function(event){
      var xml = Blockly.Xml.workspaceToDom(workspace);
      var xml_text = Blockly.Xml.domToText(xml);
      document.getElementById("msg").value = xml_text;
      
        
      var blockIds = Object.keys(workspace.blockDB_);
      for (var k in workspace.blockDB_) {
          var block = workspace.blockDB_[k];
          if (block.type=='main') {
              block.setFieldValue(genVarLine(), "VARDEC");
              
              c_code = gen_c(block);
              document.getElementById('c_code').value = c_code;
          }
      }
        
    });
  </script>
  <script>
    function UIExportToFile() {
        document.getElementById("msg").style.display = 'none';
        document.getElementById("buttWrapper").style.display = '';
        document.getElementById("import").style.display = 'none';
        
        document.getElementById('import').onclick = importFile;
    }
    //UIExportToFile();
  </script>
</body>
</html>
